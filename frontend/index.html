<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Orchestrator - Service Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Docker Orchestrator</h1>
            <p class="subtitle">Self-service container deployment with automatic DNS and reverse proxy</p>
            <div class="header-actions">
                <button class="admin-btn" id="adminBtn" title="Admin Settings">
                    ‚öôÔ∏è Admin
                </button>
                <div class="theme-toggle" id="themeToggle" title="Toggle dark/light mode">
                    <div class="theme-toggle-slider">‚òÄÔ∏è</div>
                </div>
            </div>
        </header>

        <div class="health-status-compact" id="healthStatus">
            <div class="section-header-with-toggle">
                <h3>System Status</h3>
                <button class="toggle-btn" id="toggleSystemStatus" aria-label="Toggle system status">
                    <span class="toggle-icon">‚ñº</span>
                </button>
            </div>
            <div id="systemStatusContent" class="collapsible-content">
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Docker:</span>
                        <span class="status-value" id="dockerStatus">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">NPM:</span>
                        <span class="status-value" id="npmStatus">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label" id="dnsProviderLabel">DNS Provider:</span>
                        <span class="status-value" id="ovhStatus">-</span>
                    </div>
                </div>
            </div>
        </div>

        <section class="create-service-full">
            <h2>Create DNS Record + NPM Host</h2>
            <p class="section-description">Create a CNAME record and/or configure Nginx Proxy Manager. You handle Docker containers separately.</p>

            <div class="form-validation-hint" id="formValidationHint">
                ‚ÑπÔ∏è All fields must be validated before you can create. The button will be enabled once all validations pass.
            </div>

                <form id="dnsProxyForm">
                    <div class="form-group">
                        <label for="subdomain">Subdomain *</label>
                        <input type="text" id="subdomain" name="subdomain" required
                               placeholder="my-app" pattern="[a-z0-9-]+"
                               title="Only lowercase letters, numbers, and hyphens">
                        <small>Will create: my-app.guitou.eu</small>
                        <div class="input-feedback" id="subdomainFeedback"></div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="createDNS" name="createDNS" checked>
                            Create DNS CNAME record
                        </label>
                        <small style="margin-left: 28px;">Uncheck if DNS record already exists</small>
                    </div>

                    <div id="dnsFields">
                        <div class="form-group">
                            <label for="cnameTarget">CNAME Target</label>
                            <input type="text" id="cnameTarget" name="cnameTarget"
                                   placeholder="@ or guitou.eu" value="@">
                            <small>CNAME points to (@ = guitou.eu, or specify another domain)</small>
                        </div>

                        <div class="form-group">
                            <label for="ttl">TTL (Time To Live)</label>
                            <select id="ttl" name="ttl">
                                <option value="300">5 minutes (300s)</option>
                                <option value="600">10 minutes (600s)</option>
                                <option value="1800">30 minutes (1800s)</option>
                                <option value="3600" selected>1 hour (3600s) - Default</option>
                                <option value="7200">2 hours (7200s)</option>
                                <option value="21600">6 hours (21600s)</option>
                                <option value="43200">12 hours (43200s)</option>
                                <option value="86400">24 hours (86400s)</option>
                            </select>
                            <small>How long DNS resolvers should cache this record</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="targetHost">NPM Forward Host/IP *</label>
                        <input type="text" id="targetHost" name="targetHost" required
                               placeholder="192.168.1.100 or container-name">
                        <small>IP address or hostname where your container/service is running</small>
                        <div class="input-feedback" id="targetHostFeedback"></div>
                    </div>

                    <div class="form-group">
                        <label for="targetPort">Target Port *</label>
                        <input type="number" id="targetPort" name="targetPort" required
                               placeholder="80" min="1" max="65535">
                        <small>Port where your application listens</small>
                        <div class="input-feedback" id="targetPortFeedback"></div>
                    </div>

                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="enableSSL" name="enableSSL" checked>
                            Enable SSL (Let's Encrypt)
                        </label>
                    </div>

                    <button type="submit" class="btn-primary">Create DNS + NPM Host</button>
                </form>

                <div id="createResult" class="result-message" style="display: none;"></div>
        </section>

        <div class="bottom-grid">
            <section class="npm-hosts-section">
                <div class="section-header-with-toggle">
                    <div class="header-left">
                        <h2>NPM Proxy Hosts</h2>
                        <input type="text" id="npmHostsSearch" class="search-input" placeholder="Filter hosts...">
                    </div>
                    <button class="toggle-btn" id="toggleNpmHosts" aria-label="Toggle NPM hosts">
                        <span class="toggle-icon">‚ñº</span>
                    </button>
                </div>
                <div id="npmHostsList" class="collapsible-content">
                    <p class="loading">Loading proxy hosts...</p>
                </div>
            </section>

            <section class="dns-records-section">
                <div class="section-header-with-toggle">
                    <div class="header-left">
                        <h2>Existing DNS Records (OVH)</h2>
                        <input type="text" id="dnsRecordsSearch" class="search-input" placeholder="Filter records...">
                    </div>
                    <button class="toggle-btn" id="toggleDnsRecords" aria-label="Toggle DNS records">
                        <span class="toggle-icon">‚ñº</span>
                    </button>
                </div>
                <div id="dnsRecordsList" class="collapsible-content">
                    <p class="loading">Loading DNS records...</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal-overlay" id="progressModal">
        <div class="progress-modal">
            <h3>Creating DNS Record & NPM Host</h3>
            <ul class="progress-steps" id="progressSteps">
                <!-- Steps will be dynamically inserted here -->
            </ul>
            <div class="modal-actions" id="modalActions">
                <button class="btn-modal btn-close" id="closeModal" disabled>Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="delete-modal">
            <h3>‚ö†Ô∏è Confirm Deletion</h3>

            <div class="delete-warning">
                <div class="delete-warning-icon">üóëÔ∏è</div>
                <div class="delete-warning-text">
                    This action <strong>cannot be undone</strong>. This will permanently delete:
                </div>
                <div class="delete-target" id="deleteTarget"></div>
            </div>

            <div class="delete-instruction">
                Please type <strong id="deleteRequiredText"></strong> to confirm deletion:
            </div>

            <div class="delete-input-group">
                <label for="deleteConfirmInput">Confirmation:</label>
                <input type="text" id="deleteConfirmInput" class="delete-input"
                       placeholder="Type here to confirm" autocomplete="off">
            </div>

            <div class="delete-actions">
                <button class="btn-delete-cancel" id="deleteCancelBtn">Cancel</button>
                <button class="btn-delete-confirm" id="deleteConfirmBtn" disabled>Delete Permanently</button>
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div class="modal-overlay" id="adminModal">
        <div class="admin-modal">
            <h3>‚öôÔ∏è Admin Settings</h3>
            <p class="admin-description">Manage NPM and DNS provider configuration</p>

            <!-- Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="npm">NPM Configuration</button>
                <button class="admin-tab" data-tab="dns">DNS Provider</button>
            </div>

            <!-- NPM Configuration Tab -->
            <form id="adminNpmForm" class="admin-tab-content active">
                <div class="admin-section">
                    <h4>Nginx Proxy Manager</h4>

                    <div class="form-group">
                        <label for="adminNpmUrl">NPM API URL *</label>
                        <input type="text" id="adminNpmUrl" name="npm_url" required
                               placeholder="http://192.168.1.100:81">
                        <small>NPM API endpoint (typically port 81)</small>
                    </div>

                    <div class="form-group">
                        <label for="adminNpmEmail">NPM Admin Email *</label>
                        <input type="email" id="adminNpmEmail" name="npm_email" required
                               placeholder="admin@example.com">
                        <small>Email used to log into NPM</small>
                    </div>

                    <div class="form-group">
                        <label for="adminNpmPassword">NPM Admin Password</label>
                        <input type="password" id="adminNpmPassword" name="npm_password"
                               placeholder="Leave empty to keep current password">
                        <small>Leave empty to keep the current password</small>
                        <div class="password-toggle">
                            <input type="checkbox" id="showNpmPassword">
                            <label for="showNpmPassword">Show password</label>
                        </div>
                    </div>
                </div>

                <div id="adminNpmFeedback" class="admin-feedback" style="display: none;"></div>

                <div class="admin-actions">
                    <button type="button" class="btn-admin-cancel" id="adminNpmCancelBtn">Cancel</button>
                    <button type="submit" class="btn-admin-save" id="adminNpmSaveBtn">Save NPM Config</button>
                </div>
            </form>

            <!-- DNS Configuration Tab -->
            <form id="adminDnsForm" class="admin-tab-content">
                <div class="admin-section">
                    <h4>DNS Provider Selection</h4>

                    <div class="form-group">
                        <label for="dnsProvider">DNS Provider *</label>
                        <select id="dnsProvider" name="dns_provider" required>
                            <option value="ovh">OVH</option>
                            <option value="cloudflare">Cloudflare</option>
                        </select>
                        <small>Select your DNS provider</small>
                    </div>
                </div>

                <!-- OVH Configuration -->
                <div class="admin-section dns-provider-section" id="ovhSection">
                    <h4>OVH API Configuration</h4>

                    <div class="form-group">
                        <label for="ovhEndpoint">OVH Endpoint</label>
                        <select id="ovhEndpoint" name="ovh_endpoint">
                            <option value="ovh-eu">Europe (ovh-eu)</option>
                            <option value="ovh-ca">Canada (ovh-ca)</option>
                            <option value="ovh-us">USA (ovh-us)</option>
                        </select>
                        <small>OVH API endpoint region</small>
                    </div>

                    <div class="form-group">
                        <label for="ovhAppKey">Application Key</label>
                        <input type="text" id="ovhAppKey" name="ovh_application_key"
                               placeholder="Leave empty to keep current">
                        <small>OVH API application key</small>
                    </div>

                    <div class="form-group">
                        <label for="ovhAppSecret">Application Secret</label>
                        <input type="password" id="ovhAppSecret" name="ovh_application_secret"
                               placeholder="Leave empty to keep current">
                        <div class="password-toggle">
                            <input type="checkbox" id="showOvhSecret">
                            <label for="showOvhSecret">Show secret</label>
                        </div>
                        <small>OVH API application secret</small>
                    </div>

                    <div class="form-group">
                        <label for="ovhConsumerKey">Consumer Key</label>
                        <input type="password" id="ovhConsumerKey" name="ovh_consumer_key"
                               placeholder="Leave empty to keep current">
                        <div class="password-toggle">
                            <input type="checkbox" id="showOvhConsumer">
                            <label for="showOvhConsumer">Show key</label>
                        </div>
                        <small>OVH API consumer key</small>
                    </div>

                    <div class="form-group">
                        <label for="ovhZoneName">Zone Name</label>
                        <input type="text" id="ovhZoneName" name="ovh_zone_name"
                               placeholder="example.com">
                        <small>Your domain name managed by OVH</small>
                    </div>

                    <div class="info-box" id="ovhHelpBox">
                        <strong>üìã How to get OVH API credentials:</strong><br>
                        <ol style="margin: 10px 0 10px 20px; padding: 0;">
                            <li>Enter your domain name in "Zone Name" field above</li>
                            <li id="ovhStep2" style="display: none;">
                                Click here to generate credentials:
                                <a href="#" id="ovhCredentialsLink" target="_blank" style="font-weight: bold;">
                                    Generate OVH API Token ‚Üí
                                </a>
                            </li>
                            <li id="ovhStep3" style="display: none;">
                                On the OVH page, the required permissions will be pre-filled:
                                <ul style="margin: 5px 0 5px 20px;">
                                    <li><code>GET /domain/zone/{zone}/*</code></li>
                                    <li><code>POST /domain/zone/{zone}/*</code></li>
                                    <li><code>DELETE /domain/zone/{zone}/*</code></li>
                                </ul>
                            </li>
                            <li id="ovhStep4" style="display: none;">Set a validity period (unlimited or custom)</li>
                            <li id="ovhStep5" style="display: none;">Click "Create keys" and copy the 3 credentials generated</li>
                            <li id="ovhStep6" style="display: none;">Paste them in the fields above (Application Key, Application Secret, Consumer Key)</li>
                        </ol>
                        <div id="ovhNoZone" style="margin-top: 5px;">
                            <em>‚Üí Start by entering your domain name above</em>
                        </div>
                    </div>
                </div>

                <!-- Cloudflare Configuration -->
                <div class="admin-section dns-provider-section" id="cloudflareSection" style="display: none;">
                    <h4>Cloudflare API Configuration</h4>

                    <div class="form-group">
                        <label for="cloudflareToken">API Token</label>
                        <input type="password" id="cloudflareToken" name="cloudflare_api_token"
                               placeholder="Leave empty to keep current">
                        <div class="password-toggle">
                            <input type="checkbox" id="showCloudflareToken">
                            <label for="showCloudflareToken">Show token</label>
                        </div>
                        <small>Cloudflare API token with DNS edit permissions</small>
                    </div>

                    <div class="form-group">
                        <label for="cloudflareZoneId">Zone ID</label>
                        <input type="text" id="cloudflareZoneId" name="cloudflare_zone_id"
                               placeholder="abc123def456...">
                        <small>Your Cloudflare zone ID</small>
                    </div>

                    <div class="info-box">
                        <strong>üìã How to get Cloudflare credentials:</strong><br>
                        <ol style="margin: 10px 0 10px 20px; padding: 0;">
                            <li>
                                Go to <a href="https://dash.cloudflare.com/" target="_blank" style="font-weight: bold;">Cloudflare Dashboard</a>
                            </li>
                            <li>
                                Select your domain from the list
                            </li>
                            <li>
                                <strong>Get Zone ID:</strong>
                                <ul style="margin: 5px 0 5px 20px;">
                                    <li>On the overview page, scroll down to the right sidebar</li>
                                    <li>Find "Zone ID" in the API section</li>
                                    <li>Click to copy and paste it above</li>
                                </ul>
                            </li>
                            <li>
                                <strong>Create API Token:</strong>
                                <ul style="margin: 5px 0 5px 20px;">
                                    <li>Go to <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank">Profile ‚Üí API Tokens</a></li>
                                    <li>Click "Create Token"</li>
                                    <li>Use the "Edit zone DNS" template</li>
                                    <li>Select your specific zone or all zones</li>
                                    <li>Click "Continue to summary" then "Create Token"</li>
                                    <li>Copy the token and paste it above (‚ö†Ô∏è shown only once!)</li>
                                </ul>
                            </li>
                        </ol>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 4px;">
                            <strong>‚ö†Ô∏è Important:</strong> The API token is shown only once. Save it securely!
                        </div>
                    </div>
                </div>

                <div id="adminDnsFeedback" class="admin-feedback" style="display: none;"></div>

                <div class="admin-actions">
                    <button type="button" class="btn-admin-cancel" id="adminDnsCancelBtn">Cancel</button>
                    <button type="submit" class="btn-admin-save" id="adminDnsSaveBtn">Save DNS Config</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
